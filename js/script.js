let game={size:6,theme:window.THEME||{},stages:window.LEVELS||[],stageIndex:0,preStageTotalStars:0,totalStars:0,stageStars:0,timerTotal:180,timerSec:180,timerId:null,timerStart:null,stageTimes:[]};let state,running=!1,pointer=0,expanded=[];let rotationAngle=0,popupShown=!1;let popupContext=null;const program=[];let gameOver=!1;let grid,list,levelInfo,stepInfo,promptLine,kompas,starCountEl,timerEl;let popupEl,popupCardEl,popupTextEl,popupActionsEl,popupCloseWrapEl,btnYes,btnNo,btnClose;let fxLayer;function tileSize(){return parseInt(getComputedStyle(document.documentElement).getPropertyValue("--tile"))||76}function rcToXY(e,t){const n=tileSize();return{x:t*n+n/2,y:e*n+n/2}}function flash(e,t){const n=e.style.backgroundColor;e.style.backgroundColor=t,setTimeout((()=>e.style.backgroundColor=n||""),220)}function fmtTime(e){const t=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0");return`${t}:${n}`}function inBounds(e,t){return e>=0&&t>=0&&e<game.size&&t<game.size}function currentStage(){return game.stages[game.stageIndex]}function isLastStage(){return game.stageIndex>=game.stages.length-1}function allStarsCollected(){const e=currentStage();return!e.stars||0===e.stars.length||e.stars.every((e=>!0===e.collected))}function setUlangiEnabled(e){const t=document.getElementById("btn-ulangi");t.disabled=!e,t.classList.toggle("disabled",!e)}function refreshUlangiBasedOnProgram(){const e=program.length>0,t=program[program.length-1];setUlangiEnabled(e&&"REP2"!==t)}function showPopup(e,t="confirm",n={html:!1}){popupActionsEl.style.display="none",popupCloseWrapEl.style.display="none",popupCardEl.classList.remove("square"),n.html?popupTextEl.innerHTML=e:popupTextEl.textContent=e,"confirm"===t?popupActionsEl.style.display="flex":"simple"===t?popupCloseWrapEl.style.display="flex":"simple-square"===t&&(popupCloseWrapEl.style.display="flex",popupCardEl.classList.add("square")),popupShown=!0,popupEl.classList.remove("hidden")}function hidePopup(){popupEl.classList.add("hidden"),popupShown=!1,popupActionsEl.style.display="none",popupCloseWrapEl.style.display="none"}function closePopupAndMaybeReset(){const e=popupContext;if(popupContext=null,gameOver)return void hidePopup();if(hidePopup(),"incomplete"===e)resetStageState(!1,!0);else if("advance-simple"===e)recordStage("completed"),game.stageIndex+=1,resetStageState(!0,!1)}function askSkip(){if(gameOver)return;popupContext="skip";const e="Lewati babak ini?<br><small>Kamu tidak bisa kembali ke babak ini.</small>";showPopup(e,"confirm",{html:!0})}function commitStageStars(){game.totalStars+=game.stageStars,game.preStageTotalStars=game.totalStars,starCountEl.textContent=game.totalStars,game.stageStars=0}function recordStage(e){const t=game.timerSec;game.stageTimes.push({stage:game.stageIndex+1,status:e,finishedAt:(new Date).toISOString(),remainingSec:t})}function buildLogTableHTML(){let e=game.stageTimes.map((e=>{const t=`Babak ${e.stage}`,n="completed"===e.status?"Selesai":"Dilewati",a=fmtTime(null!=e.remainingSec?e.remainingSec:0);return`<tr><td style="padding:4px 8px">${t}</td><td style="padding:4px 8px">${n}</td><td style="padding:4px 8px">${a}</td></tr>`})).join("");return e||(e='<tr><td colspan="3" style="padding:4px 8px">â€”</td></tr>'),`
    <table style="margin:0 auto;border-collapse:collapse;border:1px solid #e7c27d">
      <thead>
        <tr><th style="padding:4px 8px">Babak</th><th style="padding:4px 8px">Status</th><th style="padding:4px 8px">Sisa waktu</th></tr>
      </thead>
      <tbody>${e}</tbody>
    </table>
  `}function handleTimeUp(){if(gameOver)return;game.timerId&&(clearInterval(game.timerId),game.timerId=null),running=!1,gameOver=!0;const e=`Waktu habis!<br>Bintang terkumpul: ${game.totalStars}<br><br>`+buildLogTableHTML();popupContext=null,showPopup(e,"simple",{html:!0})}function finishGame(){if(gameOver)return;game.timerId&&(clearInterval(game.timerId),game.timerId=null),gameOver=!0;const e=`Selesai semua babak! ðŸŽ‰<br>Bintang terkumpul: ${game.totalStars}<br>Sisa waktu: ${fmtTime(game.timerSec)}<br><br>`+buildLogTableHTML();popupContext=null,showPopup(e,"simple",{html:!0}),launchConfetti()}function showLogPopup(){const e="<strong>Rekap Babak</strong><br><br>"+buildLogTableHTML();popupContext=null,showPopup(e,"simple-square",{html:!0})}function positionCharacter(){const e=document.getElementById("karakter");if(!state||!state.pos||!e)return;const{ x:t,y:n }=rcToXY(state.pos.r,state.pos.c);e.style.setProperty("--rot",rotationAngle+"deg"),e.style.left=t+"px",e.style.top=n+"px",e.style.transform=`translate(-50%,-50%) rotate(${rotationAngle}deg)`,kompas&&(kompas.style.transform=`rotate(${rotationAngle}deg)`)}function drawBoard(){const e=currentStage();grid.style.width=`calc(var(--tile) * ${game.size})`,grid.style.height=`calc(var(--tile) * ${game.size})`,grid.style.gridTemplateColumns=`repeat(${game.size}, var(--tile))`,grid.style.gridTemplateRows=`repeat(${game.size}, var(--tile))`,grid.style.backgroundImage=game.theme?.background?`url(${game.theme.background})`:"none",grid.innerHTML="";for(let e=0;e<game.size*game.size;e++){const t=document.createElement("div");t.className="kotak",grid.appendChild(t)}(e.blocks||[]).forEach((t=>{if(!inBounds(t.r,t.c))return;const n=t.r*game.size+t.c,a=grid.children[n],o=document.createElement("div");o.className="blok",game.theme?.block&&(o.style.backgroundImage=`url(${game.theme.block})`),a.appendChild(o)})),(e.stars||[]).forEach(((t,n)=>{const{ x:a,y:o }=rcToXY(t.r,t.c),r=document.createElement("div");r.className="star",r.dataset.idx=n,game.theme?.goal&&(r.style.backgroundImage=`url(${game.theme.goal})`),r.style.left=a+"px",r.style.top=o+"px",grid.appendChild(r),t._el=r,t.collected&&r.classList.add("grey")}));const t=document.createElement("div");t.className="karakter",t.id="karakter",game.theme?.character&&(t.style.backgroundImage=`url(${game.theme.character})`),grid.appendChild(t),positionCharacter(),levelInfo.textContent=`Babak ${game.stageIndex+1}/${game.stages.length} â€¢ ${game.size}Ã—${game.size} petak`;const n=e.maxSteps;stepInfo.textContent=`Batas langkah: ${"number"==typeof n?n:"â€”"}`,promptLine.textContent=e.prompt||"",starCountEl.textContent=game.totalStars,timerEl.textContent=fmtTime(game.timerSec)}function icon(e){return{F:"âž¡",L:"âŸ²",R:"âŸ³",REP2:"â¤¿Ã—2"}[e]||e}function label(e){return{F:"Maju",L:"Kiri",R:"Kanan",REP2:"Ulangi 2Ã— (ulangi perintah sebelumnya)"}[e]||e}function addCmd(e){if(gameOver)return;program.push(e);const t=document.createElement("li");t.textContent=`${icon(e)} ${label(e)}`,list.appendChild(t),refreshUlangiBasedOnProgram()}function undo(){if(gameOver)return;program.pop(),null==list.lastElementChild||list.lastElementChild.remove(),refreshUlangiBasedOnProgram()}function clearProgram(){if(gameOver)return;program.length=0,list.innerHTML="",refreshUlangiBasedOnProgram()}function expandProgram(){const e=[];for(let t=0;t<program.length;t++)if("REP2"===program[t]){if(e.length>0){const t=e[e.length-1];e.push(t,t)}}else e.push(program[t]);return e}function startTimer(){function e(){if(gameOver)return void(game.timerId&&(clearInterval(game.timerId),game.timerId=null));const e=Date.now(),t=Math.floor((e-game.timerStart)/1e3),n=Math.max(0,game.timerTotal-t);n!==game.timerSec&&(game.timerSec=n,timerEl.textContent=fmtTime(game.timerSec)),0===n&&handleTimeUp()}game.timerId&&clearInterval(game.timerId),game.timerStart||(game.timerStart=Date.now()),e(),game.timerId=setInterval(e,500)}function inBlocks(e,t){return(currentStage().blocks||[]).some((n=>n.r===e&&n.c===t))}function doCmd(e){const t=document.getElementById("karakter");if("L"===e)return state.pos.dir=(state.pos.dir+3)%4,rotationAngle-=90,void positionCharacter();if("R"===e)return state.pos.dir=(state.pos.dir+1)%4,rotationAngle+=90,void positionCharacter();if("F"===e){const n=[[0,1],[1,0],[0,-1],[-1,0]][state.pos.dir],a=state.pos.r+n[0],o=state.pos.c+n[1];if(!inBounds(a,o)||inBlocks(a,o))return running=!1,flash(grid,"#ffd2d2"),t&&(t.classList.remove("shake"),t.offsetWidth,t.classList.add("shake")),void(popupShown||showPopup("Dino terbentur. Coba lagi!","simple"));state.pos.r=a,state.pos.c=o,positionCharacter(),checkStarCollect(a,o)}}function spawnSparklesAt(e,t){for(let n=0;n<10;n++){const n=document.createElement("div");n.className="sparkle";const a=2*Math.PI*Math.random(),o=2*Math.PI*Math.random(),r=12+16*Math.random(),s=28+32*Math.random();n.style.left=e+"px",n.style.top=t+"px",n.style.setProperty("--x0","0px"),n.style.setProperty("--y0","0px"),n.style.setProperty("--x1",`${Math.cos(a)*r}px`),n.style.setProperty("--y1",`${Math.sin(a)*r}px`),n.style.setProperty("--x2",`${Math.cos(o)*s}px`),n.style.setProperty("--y2",`${Math.sin(o)*s}px`),fxLayer.appendChild(n),setTimeout((()=>n.remove()),800)}}function flyStarToCounter(e){const t=e._el.getBoundingClientRect(),n=document.getElementById("star-counter"),a=n.getBoundingClientRect(),o=document.createElement("div");o.textContent="â˜…",o.style.position="fixed",o.style.left=t.left+"px",o.style.top=t.top+"px",o.style.fontSize="22px",o.style.color="#ffc107",o.style.transition="transform 600ms ease, opacity 600ms ease",o.style.transform="translate(0,0) scale(1)",o.style.opacity="1",fxLayer.appendChild(o);const r=a.left+a.width/2-t.left,s=a.top+a.height/2-t.top;requestAnimationFrame((()=>{o.style.transform=`translate(${r}px, ${s}px) scale(0.6)`,o.style.opacity="0.2"})),setTimeout((()=>{o.remove();const t=a.left+a.width/2,n=a.top+a.height/2;starCountEl.textContent=game.preStageTotalStars+game.stageStars,spawnSparklesAt(t,n)}),650)}function launchConfetti(){const e=window.innerWidth/2,t=window.innerHeight/3,n=["#ff3b3b","#ffd166","#06d6a0","#118ab2","#8338ec","#ef476f"];for(let a=0;a<60;a++){const o=document.createElement("div");o.className="confetti",o.style.background=n[a%n.length],o.style.setProperty("--cx",e+"px"),o.style.setProperty("--cy",t+"px");const r=280*(2*Math.random()-1),s=120*(2*Math.random()-1);o.style.setProperty("--dx",r+"px"),o.style.setProperty("--dy",s+"px"),fxLayer.appendChild(o),setTimeout((()=>o.remove()),1400)}}function checkStarCollect(e,t){const n=currentStage();for(let a=0;a<n.stars.length;a++){const o=n.stars[a];if(!o.collected&&o.r===e&&o.c===t)return o.collected=!0,o._el&&o._el.classList.add("grey"),game.stageStars+=1,void flyStarToCounter(o)}}function programCommandCount(){return program.length}function runAll(){if(running||gameOver)return;const e=currentStage(),t=e.maxSteps,n=programCommandCount();if("number"==typeof t&&n>t)return void showPopup(`Batas langkah babak ini adalah ${t} perintah.<br>Perintah kamu: ${n}. Kurangi dulu ya.`,"simple",{html:!0});if(expanded=expandProgram(),pointer=0,running=!0,0===expanded.length)return flash(grid,"#fff2c7"),void(running=!1);const a=setInterval((()=>{if(!running)return void clearInterval(a);const e=expanded[pointer++];if(doCmd(e),pointer>=expanded.length||!running){if(clearInterval(a),running=!1,popupShown||gameOver)return;allStarsCollected()?isLastStage()?(recordStage("completed"),commitStageStars(),finishGame()):(popupContext="advance-simple",showPopup("Selamat! Semua bintang di babak ini sudah terkumpul.","simple",{html:!0})):(popupContext="incomplete",showPopup("Belum semua bintang terkumpul. Tambah perintah lagi ya!","simple"))}}),350)}function resetStageState(e=!1,t=!1){if(gameOver)return;const n=currentStage();e?commitStageStars():starCountEl.textContent=game.totalStars,running=!1,pointer=0,expanded=[],(n.stars||[]).forEach((e=>{e.collected=!1,e._el=null})),state={pos:{...n.start}},rotationAngle=90*(state.pos.dir||0),drawBoard(),t||clearProgram(),game.stageStars=0,refreshUlangiBasedOnProgram()}function nextStage(){gameOver||(isLastStage()?(commitStageStars(),finishGame()):(game.stageIndex+=1,resetStageState(!0,!1),popupShown=!1))}const INFO_HTML="\n  <strong>Cara pakai:</strong>\n  <ol style=\"text-align:left; margin:8px 0 0 18px; padding:0;\">\n    <li>Susun perintah: âž¡ Maju, âŸ² Kiri, âŸ³ Kanan.</li>\n    <li>'Ulangi 2Ã—' mengulang perintah sebelumnya dua kali (tetap dihitung 1 perintah).</li>\n    <li>Tekan <em>Jalankan</em>.</li>\n    <li>Kumpulkan <strong>semua</strong> bintang. Kalau belum semua, Dino akan kembali ke awal dan programmu tetap tersimpan.</li>\n    <li>Jika batas langkah aktif, jangan melebihi jumlah perintah.</li>\n    <li>Kalau buntu, gunakan tombol <em>Lewati Babak</em> (tidak bisa kembali).</li>\n  </ol>\n";document.addEventListener("DOMContentLoaded",(()=>{if(grid=document.getElementById("grid"),list=document.getElementById("list"),levelInfo=document.getElementById("level-info"),stepInfo=document.getElementById("step-limit-info"),promptLine=document.getElementById("prompt-line"),kompas=document.getElementById("kompas"),starCountEl=document.getElementById("star-count"),timerEl=document.getElementById("timer"),popupEl=document.getElementById("popup"),popupCardEl=document.getElementById("popup-card"),popupTextEl=document.getElementById("popup-text"),popupActionsEl=document.getElementById("popup-actions"),popupCloseWrapEl=document.getElementById("popup-close-wrap"),btnYes=document.getElementById("popup-yes"),btnNo=document.getElementById("popup-no"),btnClose=document.getElementById("popup-close"),fxLayer=document.getElementById("fx-layer"),document.getElementById("btn-maju").onclick=()=>addCmd("F"),document.getElementById("btn-kiri").onclick=()=>addCmd("L"),document.getElementById("btn-kanan").onclick=()=>addCmd("R"),document.getElementById("btn-ulangi").onclick=()=>addCmd("REP2"),document.getElementById("btn-undo").onclick=()=>undo(),document.getElementById("btn-reset").onclick=()=>{clearProgram(),resetStageState(!1,!1),flash(grid,"#eefcff")},document.getElementById("btn-run").onclick=()=>runAll(),document.getElementById("btn-info"))document.getElementById("btn-info").onclick=()=>{popupContext=null,showPopup(INFO_HTML,"simple-square",{html:!0})};const e=document.getElementById("btn-skip");e&&(e.onclick=()=>askSkip());const t=document.getElementById("btn-log");t&&(t.onclick=()=>showLogPopup()),["btn-maju","btn-kiri","btn-kanan","btn-ulangi"].forEach((e=>{const t=document.getElementById(e);t.draggable=!0,t.addEventListener("dragstart",(t=>t.dataTransfer.setData("text/plain",e)))}));const n=document.getElementById("program");if(n.addEventListener("dragover",(e=>e.preventDefault())),n.addEventListener("drop",(e=>{e.preventDefault();const t=e.dataTransfer.getData("text/plain"),n={ "btn-maju":"F","btn-kiri":"L","btn-kanan":"R","btn-ulangi":"REP2"};n[t]&&addCmd(n[t])})),popupEl.addEventListener("click",(e=>{e.target===popupEl&&closePopupAndMaybeReset()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&closePopupAndMaybeReset()})),btnClose.addEventListener("click",(()=>closePopupAndMaybeReset())),btnYes.addEventListener("click",(()=>{if(gameOver)return;const e=popupContext;if(popupContext=null,hidePopup(),"skip"===e){if(recordStage("skipped"),isLastStage())return void finishGame();return game.stageIndex+=1,void resetStageState(!1,!1)}isLastStage()?(commitStageStars(),recordStage("completed"),finishGame()):(game.stageIndex+=1,resetStageState(!0,!1))})),btnNo.addEventListener("click",(()=>{gameOver||(hidePopup(),popupContext=null,resetStageState(!1,!0))})),!Array.isArray(game.stages)||0===game.stages.length)return void showPopup('Level belum tersedia. Pastikan "levels/stages.js" terpasang.',"simple");game.stages.forEach((e=>{e.blocks=e.blocks||[],e.stars=e.stars||[],e.start||(e.start={r:5,c:0,dir:0}),e.stars.forEach((e=>{"boolean"!=typeof e.collected&&(e.collected=!1)}))})),game.size=6,game.stageIndex=0,game.preStageTotalStars=0,game.totalStars=0,game.stageStars=0,game.timerTotal=180,game.timerSec=180,game.timerStart=null,game.stageTimes=[],gameOver=!1,clearProgram(),resetStageState(!1,!0),startTimer(),popupActionsEl.style.display="none",popupCloseWrapEl.style.display="none",document.addEventListener("visibilitychange",(()=>{if(!document.hidden&&game.timerStart&&!gameOver){const e=Date.now(),t=Math.floor((e-game.timerStart)/1e3),n=Math.max(0,game.timerTotal-t);game.timerSec=n,timerEl.textContent=fmtTime(game.timerSec),0===n&&handleTimeUp()}}))}));
